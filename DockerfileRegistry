ARG NODE_VERSION=10.14.2
ARG OWNER=pagopa
ARG REPO=repo

FROM circleci/node:$NODE_VERSION as builder

WORKDIR /home/circleci

COPY src src
COPY package.json package.json
COPY tsconfig.json tsconfig.json
COPY yarn.lock yarn.lock

RUN yarn install && yarn build

FROM node:$NODE_VERSION-alpine
LABEL maintainer="https://pagopa.it"
LABEL org.opencontainers.image.source https://github.com/$OWNER/$REPO

WORKDIR /usr/src/app

COPY /package.json /usr/src/app/package.json
COPY --from=builder /home/circleci/dist /usr/src/app/dist
COPY --from=builder /home/circleci/node_modules /usr/src/app/node_modules
COPY --from=builder /home/circleci/generated /usr/src/app/generated

EXPOSE 8080

ENTRYPOINT ["node", "dist/src/server.js"]
